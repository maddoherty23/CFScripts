!function() {
    window.TICKET_GATOR = {
        init(t = "ticket-container") {
            if (!document.getElementById(t)) {
                const e = document.createElement("div");
                e.id = t;
                document.currentScript.parentElement.appendChild(e);
            }
            const e = document.getElementById(t);
            this.r = document.createElement("iframe");
            this.r.id = "ticketFrame";
            this.r.src = "https://ticketgatorapp.netlify.app";
            this.r.style = "width:100%;height:450px;border:none";
            
            this.i = document.createElement("div");
            this.i.id = "bookingInfo";
            this.i.style = "display:none;margin:20px;padding:15px;background:#f8f9fa;border-radius:8px;border:1px solid #dee2e6";
            this.i.innerHTML = '<div>Booking ID: <span id="bookingId" style="font-family:monospace;font-size:16px;color:#0066cc"></span></div><div>Status: <span id="status">Pending</span></div>';
            
            e.appendChild(this.r);
            e.appendChild(this.i);
            this.r.onload = () => this.s();
            window.addEventListener("message", t => this.h(t))
        },

        s() {
            this.r.contentWindow.postMessage({
                type: "setVariables",
                data: {
                    teamId: "1",
                    apiUrl: "https://madgator-f55ad62309d2.herokuapp.com",
                    eventId: "1"
                }
            }, "https://ticketgatorapp.netlify.app")
        },

        async h(t) {
            if ("https://ticketgatorapp.netlify.app" !== t.origin) return;
            const {type: e, payload: i} = t.data;
            
            if ("BOOKING_CREATED" === e) {
                console.log('üé´ Booking received:', i);
                this.i.style.display = "block";
                document.getElementById("bookingId").textContent = i.bookingId;
                
                try {
                    console.log('üé´ Processing booking:', i.bookingId);
                    const t = await fetch("https://madgator-f55ad62309d2.herokuapp.com/api/bookings/process", {
                        method: "POST",
                        headers: {"Content-Type": "application/json"},
                        body: JSON.stringify(i)
                    });
                    
                    const e = await t.json();
                    console.log('‚úÖ Booking processed:', i.bookingId);
                    document.getElementById("status").textContent = "Confirmed";
                    
                    const n = new URLSearchParams(window.location.search);
                    n.set("next_funnel_step", "true");
                    const o = window.location.pathname + "?" + n.toString();
                    window.location.href = o;
                    
                } catch(t) {
                    console.error('‚ùå Booking error:', t);
                    document.getElementById("status").textContent = "Error";
                }
            }
            
            if ("heightUpdate" === e) {
                this.r.style.height = i + "px";
            }
        }
    };
    
    TICKET_GATOR.init();
}();
