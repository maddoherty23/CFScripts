!function() {
    window.TICKET_GATOR = {
        init(containerId = "ticket-container") {
            console.log('ğŸ« Initializing TICKET_GATOR - Event Booking');

            // Ensure TICKET_CONFIG exists
            if (!window.TICKET_CONFIG) {
                console.error("âŒ Missing TICKET_CONFIG. Cannot initialize TICKET_GATOR.");
                return;
            }

            const { teamId, eventId, apiUrl, ticketingConfig, confirmationUrl } = window.TICKET_CONFIG;

            // Validate required fields
            if (!teamId || !eventId || !apiUrl || !ticketingConfig || !confirmationUrl) {
                console.error("âŒ TICKET_CONFIG is missing required values.");
                return;
            }

            if (!document.getElementById(containerId)) {
                const container = document.createElement("div");
                container.id = containerId;
                document.currentScript.parentElement.appendChild(container);
            }

            const container = document.getElementById(containerId);

            // Create iframe for ticket system
            this.iframe = document.createElement("iframe");
            this.iframe.id = "ticketFrame";
            this.iframe.src = "https://ticketgatorapp.netlify.app";
            this.iframe.style = "width:100%;height:450px;border:none";

            container.appendChild(this.iframe);

            this.iframe.onload = () => this.setIframeVariables();
            window.addEventListener("message", (event) => this.handleMessage(event));

            console.log('ğŸ« TICKET_GATOR initialized successfully - Event Booking');
        },

        setIframeVariables() {
            console.log('ğŸ« Setting iframe variables');

            if (!window.TICKET_CONFIG) {
                console.error("âŒ TICKET_CONFIG not found. Cannot send variables to iframe.");
                return;
            }

            const { teamId, eventId } = window.TICKET_CONFIG;

            if (!teamId || !eventId) {
                console.error("âŒ Missing required parameters in TICKET_CONFIG.");
                return;
            }

            this.iframe.contentWindow.postMessage({
                type: "setVariables",
                data: { teamId, eventId }
            }, "https://ticketgatorapp.netlify.app");

            console.log('ğŸ« Variables sent to iframe:', { teamId, eventId });
        },

        handleMessage(event) {
            if (event.origin !== "https://ticketgatorapp.netlify.app") {
                console.warn('ğŸ« Ignored message from unauthorized origin:', event.origin);
                return;
            }

            const { type, payload } = event.data;
            console.log('ğŸ« Received message type:', type);

            if (type === "BOOKING_CREATED") {
                console.log('ğŸ« Booking created with ID:', payload.bookingId);

                // Display booking info
                this.bookingInfo.style.display = "block";
                document.getElementById("bookingId").textContent = payload.bookingId;
                document.getElementById("status").textContent = "Confirmed";

                // Send success message to ClickFunnels
                if (window.parent) {
                    console.log('ğŸ« Sending success message to ClickFunnels');
                    window.parent.postMessage({ event: "bookingSuccess", bookingId: payload.bookingId }, "*");
                }

                // Update URL for tracking
                const params = new URLSearchParams(window.location.search);
                params.set("next_funnel_step", "true");
                const newUrl = window.location.pathname + "?" + params.toString();
                console.log('ğŸ« Updating URL:', newUrl);
                window.history.replaceState({}, "", newUrl);
            }
        }
    };

    console.log('ğŸ« Starting TICKET_GATOR - Event Booking');
    TICKET_GATOR.init();
}();
